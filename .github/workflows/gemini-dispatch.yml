---
name: ðŸ”€ Gemini Dispatch

on:
  pull_request:
    types:
      - opened
      - synchronize
      - ready_for_review
  issue_comment:
    types:
      - created
  pull_request_review_comment:
    types:
      - created
  pull_request_review:
    types:
      - submitted

defaults:
  run:
    shell: bash

jobs:
  dispatch:
    # For PRs: only if not from a fork
    # For comments: only if user types @gemini-cli and is OWNER/MEMBER/COLLABORATOR
    if: |-
      (
        github.event_name == 'pull_request' &&
        github.event.pull_request.head.repo.fork == false &&
        github.event.pull_request.draft == false
      ) || (
        github.event.sender.type == 'User' &&
        startsWith(github.event.comment.body || github.event.review.body || '', '@gemini-cli') &&
        contains(
          fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'),
          github.event.comment.author_association ||
          github.event.review.author_association || ''
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    outputs:
      command: ${{ steps.extract_command.outputs.command }}
      additional_context: ${{ steps.extract_command.outputs.additional_context }}
    steps:
      - name: Extract command
        id: extract_command
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
        env:
          EVENT_TYPE: ${{ github.event_name }}.${{ github.event.action }}
          REQUEST: ${{ github.event.comment.body || github.event.review.body || '' }}
        with:
          script: |
            const eventType = process.env.EVENT_TYPE;
            const request = process.env.REQUEST;

            if (['pull_request.opened', 'pull_request.synchronize', 'pull_request.ready_for_review'].includes(eventType)) {
              core.setOutput('command', 'review');
            } else if (request.startsWith('@gemini-cli /review')) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini-cli \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request.startsWith('@gemini-cli')) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini-cli/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else {
              core.setOutput('command', 'skip');
            }

      - name: Acknowledge request
        if: steps.extract_command.outputs.command == 'review' && github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |-
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– Working on it! Track progress [in the logs](${RUN_URL})." \
            --repo "${{ github.repository }}"

  review:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'review'
    uses: ./.github/workflows/gemini-review.yml
    permissions:
      contents: read
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
    secrets: inherit
